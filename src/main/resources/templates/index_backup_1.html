<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PRINTER</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 500px; /* Limit max width on larger screens */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px; /* Spacing between elements */
        }
        #fileInputLabel {
            display: block;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            width: 80%;
            max-width: 200px;
        }
        #fileInput {
            display: none; /* Hide the default file input */
        }
        #fileNameDisplay {
            margin-top: 5px;
            font-style: italic;
            color: #555;
            word-break: break-all;
        }
        .preview-container {
            border: 1px solid #ddd;
            padding: 15px;
            width: 100%;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-sizing: border-box;
        }
        #preview {
            max-width: 100%;
            max-height: 300px; /* Limit preview height */
            display: flex; /* Use flex for centering content */
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Hide overflow */
        }
        .preview-image, .pdf-preview {
            max-width: 100%;
            max-height: 280px; /* Adjust based on container padding/border */
            object-fit: contain; /* Show entire image/page */
        }
        .page-count, .price-display {
            margin-top: 10px;
            font-weight: bold;
            color: #333;
        }
        .radio-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Align labels left */
            gap: 10px;
            width: 100%;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .color-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .color-label span { font-weight: bold; }
        .c { color: red; } .o1 { color: orange; } .l { color: blue; } .o2 { color: green; } .r { color: purple; }

        #pay-button {
            background-color: #28a745; /* Green color for pay */
            color: white;
            border: none;
            border-radius: 5px;
            padding: 12px 25px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 80%;
            max-width: 250px;
            margin-top: 10px;
        }
        #pay-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #statusMessage {
            margin-top: 15px;
            color: red;
            font-weight: bold;
            min-height: 1em; /* Reserve space */
        }
        /* Simple loader */
        .loader {
             border: 4px solid #f3f3f3; /* Light grey */
             border-top: 4px solid #3498db; /* Blue */
             border-radius: 50%;
             width: 20px;
             height: 20px;
             animation: spin 2s linear infinite;
             display: none; /* Hidden by default */
             margin: 10px auto;
        }
        @keyframes spin {
             0% { transform: rotate(0deg); }
             100% { transform: rotate(360deg); }
        }

    </style>
    <!-- Include pdf.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <!-- Include Razorpay Checkout library -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
    <div class="container">
        <h1>Printer</h1>

        <!-- File Input -->
        <label for="fileInput" id="fileInputLabel">Select File</label>
        <input type="file" id="fileInput" accept=".pdf, image/jpeg, image/png, image/jpg" />
        <div id="fileNameDisplay">No file selected</div>
         <div class="loader" id="uploadLoader"></div> <!-- Loader for upload -->

        <!-- Preview Area -->
        <div class="preview-container">
            <h3>Preview</h3>
            <div id="preview"><p>Select a file to see preview.</p></div>
            <div id="pageCountDisplay" class="page-count"></div>
        </div>

        <!-- Print Type Selection -->
        <div class="radio-group">
            <h3>Select Print Type</h3>
            <label class="color-option">
                <input type="radio" name="printType" value="0" required checked>
                Black and White <span id="bwPrice"></span>
            </label>
            <label class="color-option">
                <input type="radio" name="printType" value="1" required >
                <span class="color-label">
                    <span class="c">C</span><span class="o1">o</span><span class="l">l</span><span class="o2">o</span><span class="r">r</span>
                </span>
                 <span id="colorPrice"></span>
            </label>
        </div>

        <!-- Price Display -->
        <div id="priceDisplay" class="price-display">Select file and print type to see price.</div>

        <!-- Status Message -->
        <div id="statusMessage"></div>

         <!-- Loader for Payment -->
         <div class="loader" id="paymentLoader"></div>

        <!-- Pay Button -->
        <button id="pay-button" disabled>Pay Now</button>
    </div>

    <script>
        // Global state variables (managed in browser)
        let currentFileInfo = null; // Stores { fileName, pageCount, url, mimeType }
        let currentPrintType = 0; // Default B&W

        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const previewDiv = document.getElementById('preview');
        const pageCountDisplay = document.getElementById('pageCountDisplay');
        const priceDisplay = document.getElementById('priceDisplay');
        const payButton = document.getElementById('pay-button');
        const statusMessage = document.getElementById('statusMessage');
        const printTypeRadios = document.querySelectorAll('input[name="printType"]');
        const uploadLoader = document.getElementById('uploadLoader');
        const paymentLoader = document.getElementById('paymentLoader');

        // --- Event Listeners ---

        fileInput.addEventListener('change', handleFileSelect);
        printTypeRadios.forEach(radio => {
            radio.addEventListener('change', handlePrintTypeChange);
        });
        payButton.addEventListener('click', initiatePayment);

        // --- Functions ---

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                resetUploadState();
                return;
            }

            fileNameDisplay.textContent = `Selected: ${file.name}`;
            statusMessage.textContent = ''; // Clear previous errors
            payButton.disabled = true; // Disable button during upload
            uploadLoader.style.display = 'block'; // Show loader
            previewDiv.innerHTML = '<p>Uploading and processing...</p>'; // Temp message
            pageCountDisplay.textContent = '';
            priceDisplay.textContent = '';


            // Optional: Show temporary image preview immediately (if image)
            if (file.type.startsWith('image/')) {
                 showTempImagePreview(file);
            } else {
                 previewDiv.innerHTML = '<p>Processing preview...</p>';
            }


            uploadFileToServer(file);
        }

        function showTempImagePreview(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                 const img = document.createElement('img');
                 img.src = e.target.result;
                 img.className = 'preview-image';
                 previewDiv.innerHTML = ''; // Clear loading message
                 previewDiv.appendChild(img);
            };
            reader.readAsDataURL(file);
        }


        function uploadFileToServer(file) {
            const formData = new FormData();
            formData.append('file', file);

            fetch('/print/upload', { // Use relative path
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    // Try to parse error message from backend
                    return response.json().then(errData => {
                         throw new Error(errData.error || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                console.log('Upload successful:', data);
                currentFileInfo = {
                    fileName: data.fileName,
                    pageCount: data.pageCount,
                    url: data.url,
                    mimeType: file.type // Store MIME type from the file object
                };
                showServerPreview(currentFileInfo);
                updatePriceDisplay(); // Update price after getting page count
                checkButtonState(); // Enable button if needed
            })
            .catch(error => {
                console.error('Upload Error:', error);
                statusMessage.textContent = `Upload failed: ${error.message}`;
                resetUploadState();
            })
            .finally(() => {
                 uploadLoader.style.display = 'none'; // Hide loader
            });
        }

        function resetUploadState() {
            currentFileInfo = null;
            fileNameDisplay.textContent = 'No file selected';
            previewDiv.innerHTML = '<p>Select a file to see preview.</p>';
            pageCountDisplay.textContent = '';
            priceDisplay.textContent = 'Select file and print type to see price.';
            checkButtonState();
        }

        function handlePrintTypeChange(event) {
            currentPrintType = parseInt(event.target.value, 10);
            console.log('Print type changed:', currentPrintType);
            updatePriceDisplay();
            checkButtonState();
        }

        function updatePriceDisplay() {
             // Clear previous price hints
            document.getElementById('bwPrice').textContent = '';
            document.getElementById('colorPrice').textContent = '';

            if (currentFileInfo && currentFileInfo.pageCount > 0) {
                const bwAmount = calculatePrice(currentFileInfo.pageCount, 0);
                const colorAmount = calculatePrice(currentFileInfo.pageCount, 1);

                // Display hints next to radio buttons
                document.getElementById('bwPrice').textContent = `(Rs. ${bwAmount})`;
                document.getElementById('colorPrice').textContent = `(Rs. ${colorAmount})`;

                 // Display the price for the currently selected type
                const selectedAmount = calculatePrice(currentFileInfo.pageCount, currentPrintType);
                priceDisplay.textContent = `Calculated Price: Rs. ${selectedAmount}`;
            } else {
                priceDisplay.textContent = 'Select file and print type to see price.';
            }
        }


        function calculatePrice(pages, printType) {
             if (pages <= 0) return 0;
             let amount = 0;
             if (printType === 0) { // B&W
                 amount = (pages <= 2) ? pages * 10 : (pages - 2) * 2 + 20;
             } else { // Color
            	 amount = (pages <= 1) ? pages * 20 : (pages - 1) * 5 + 20; // Match backend logic
             }
             return amount;
        }


        function checkButtonState() {
            payButton.disabled = !(currentFileInfo && currentFileInfo.pageCount > 0);
             // Implicitly, print type is always selected due to default 'checked'
        }

        function initiatePayment() {
            if (!currentFileInfo) {
                statusMessage.textContent = 'Please upload a file first.';
                return;
            }

            payButton.disabled = true; // Disable during payment processing
            paymentLoader.style.display = 'block'; // Show loader
            statusMessage.textContent = 'Initiating payment...';

            const payload = {
                fileName: currentFileInfo.fileName,
                pageCount: currentFileInfo.pageCount,
                printType: currentPrintType
            };

            fetch('/print/api/payments/initiate', { // Call the new backend endpoint
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            })
            .then(response => {
                 if (!response.ok) {
                     return response.json().then(errData => {
                          throw new Error(errData.error || `Payment initiation failed: ${response.status}`);
                     });
                 }
                 return response.json();
             })
            .then(orderData => {
                console.log('Order Data Received:', orderData);
                statusMessage.textContent = 'Redirecting to payment gateway...';
                openRazorpayCheckout(orderData);
            })
            .catch(error => {
                console.error('Payment Initiation Error:', error);
                statusMessage.textContent = `Error: ${error.message}`;
                payButton.disabled = false; // Re-enable button on error
                paymentLoader.style.display = 'none'; // Hide loader
            });
        }

        function openRazorpayCheckout(orderData) {
             const options = {
                 key: orderData.razorpayKey, // Use key from backend
                 amount: orderData.amount, // Amount in paise from backend
                 currency: orderData.currency,
                 name: "KsDigitalServices", // Customize your shop name
                 description: `Print Job: ${currentFileInfo.fileName}`,
                 order_id: orderData.orderId, // Use order_id from backend
                 handler: function (response) {
                     // This handler runs client-side on success
                     // IMPORTANT: Actual confirmation and email sending happens via backend webhook
                     console.log("Razorpay Payment ID:", response.razorpay_payment_id);
                     console.log("Razorpay Order ID:", response.razorpay_order_id);
                     console.log("Razorpay Signature:", response.razorpay_signature);
                     statusMessage.textContent = "Payment Successful! Your print job is being processed.";
                     // Optionally redirect or update UI further
                     // Don't trigger email from here!
                     resetUploadState(); // Reset form after successful initiation
                 },
                 prefill: {
                     // Optional: Prefill user details if available
                     // name: "Customer Name",
                     // email: "customer@example.com",
                     // contact: "9999999999"
                 },
                 notes: {
                     // Notes are primarily set by backend now, but you could add frontend-specific notes if needed
                     // file_source: "web_upload"
                 },
                 theme: {
                     color: "#3399cc" // Customize theme color
                 },
                 modal: {
                     ondismiss: function() {
                         console.log('Checkout form closed');
                         statusMessage.textContent = 'Payment cancelled or window closed.';
                         payButton.disabled = false; // Re-enable button if closed without paying
                         paymentLoader.style.display = 'none'; // Hide loader
                     }
                 }
             };

             try {
                const rzp = new Razorpay(options);

                 // Event listener for payment failure
                 rzp.on('payment.failed', function (response){
                      console.error("Razorpay Payment Failed:", response.error);
                      statusMessage.textContent = `Payment Failed: ${response.error.description} (Code: ${response.error.code})`;
                      // Log more details: response.error.metadata.order_id, response.error.metadata.payment_id
                      payButton.disabled = false; // Re-enable button on failure
                      paymentLoader.style.display = 'none'; // Hide loader
                 });

                paymentLoader.style.display = 'none'; // Hide loader before opening modal
                rzp.open();

             } catch(e) {
                 console.error("Error initializing Razorpay:", e);
                 statusMessage.textContent = "Could not initialize payment gateway.";
                 payButton.disabled = false; // Re-enable button
                 paymentLoader.style.display = 'none'; // Hide loader
             }
        }


        // --- Preview Rendering ---

         function showServerPreview(fileInfo) {
             previewDiv.innerHTML = ''; // Clear previous preview or loading messages
             pageCountDisplay.textContent = `Pages: ${fileInfo.pageCount || 'N/A'}`;


             if (!fileInfo.url) {
                 previewDiv.innerHTML = '<p>Preview URL missing.</p>';
                 return;
             }

             if (fileInfo.mimeType.startsWith('image/')) {
                 const img = document.createElement('img');
                 img.src = fileInfo.url; // Use the URL from the server response
                 img.className = 'preview-image';
                 img.onerror = () => { previewDiv.innerHTML = '<p>Error loading image preview.</p>'; };
                 previewDiv.appendChild(img);

             } else if (fileInfo.mimeType === 'application/pdf') {
                 const canvas = document.createElement('canvas');
                 canvas.className = 'pdf-preview';
                 previewDiv.appendChild(canvas);
                 renderPdfPreview(fileInfo.url, canvas);

             } else {
                 previewDiv.innerHTML = `<p>Preview not available for this file type (${fileInfo.mimeType}).</p>`;
             }
         }


        function renderPdfPreview(pdfUrl, canvasElement) {
             // Use PDF.js
             const loadingTask = pdfjsLib.getDocument(pdfUrl);
             loadingTask.promise.then(pdf => {
                 console.log('PDF loaded');
                 // Fetch the first page
                 pdf.getPage(1).then(page => {
                     console.log('Page 1 loaded');
                     // Calculate viewport scale to fit the preview container width
                     const desiredWidth = previewDiv.clientWidth * 0.95; // Target width (e.g., 95% of container)
                     const viewport = page.getViewport({ scale: 1 });
                     const scale = desiredWidth / viewport.width;
                     const scaledViewport = page.getViewport({ scale: scale });


                     canvasElement.height = scaledViewport.height;
                     canvasElement.width = scaledViewport.width;


                     // Render PDF page into canvas context
                     const renderContext = {
                         canvasContext: canvasElement.getContext('2d'),
                         viewport: scaledViewport
                     };
                     const renderTask = page.render(renderContext);
                     renderTask.promise.then(() => {
                         console.log('Page rendered');
                     }).catch(renderError => {
                         console.error('Error rendering PDF page:', renderError);
                         previewDiv.innerHTML = '<p>Error rendering PDF preview.</p>';
                     });
                 }).catch(pageError => {
                      console.error('Error getting PDF page:', pageError);
                      previewDiv.innerHTML = '<p>Error loading PDF page for preview.</p>';
                 });
             }).catch(pdfError => {
                 console.error('Error loading PDF document:', pdfError);
                 // Check for specific errors like CORS or network issues
                 if (pdfError.name === 'CorsError' || pdfError.message.includes('NetworkError')) {
                      previewDiv.innerHTML = '<p>Could not load PDF for preview due to network or CORS issue. Ensure the server allows access.</p>';
                 } else {
                     previewDiv.innerHTML = '<p>Error loading PDF for preview.</p>';
                 }
             });
         }


        // Initial setup
        updatePriceDisplay(); // Show initial price state
        checkButtonState(); // Set initial button state


    </script>
</body>
</html>